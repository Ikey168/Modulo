# Vulnerability Remediation Playbook

## Quick Response Guide

| Severity | Response Time | Actions Required |
|----------|---------------|------------------|
| **Critical** | Immediate (< 1 hour) | Disable feature, hotfix, security review |
| **High** | Within 24 hours | Fix, test, deploy |
| **Medium** | Within 1 week | Plan fix, implement, review |
| **Low** | Within 1 month | Scheduled maintenance |

## Critical Vulnerabilities

### 1. SQL Injection (CWE-89)

**Impact**: Complete database compromise
**CVSS**: 9.8 (Critical)

#### Immediate Response
```bash
# 1. Identify affected endpoints
grep -r "Statement\|createQuery\|createNativeQuery" backend/src/

# 2. Disable vulnerable endpoints (if possible)
# Add to application.yml:
management:
  endpoints:
    web:
      exposure:
        exclude: vulnerable-endpoint

# 3. Monitor database logs
tail -f /var/log/postgresql/postgresql.log | grep -i "error\|syntax"
```

#### Permanent Fix
```java
// Replace all dynamic SQL with parameterized queries
// BEFORE (vulnerable):
String sql = "SELECT * FROM users WHERE email = '" + email + "'";
Query query = entityManager.createNativeQuery(sql);

// AFTER (secure):
String sql = "SELECT * FROM users WHERE email = :email";
Query query = entityManager.createNativeQuery(sql)
    .setParameter("email", email);

// Or use JPA repositories:
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    @Query("SELECT u FROM User u WHERE u.email = :email")
    Optional<User> findByEmail(@Param("email") String email);
}
```

### 2. Remote Code Execution (CWE-94)

**Impact**: Complete server compromise
**CVSS**: 9.8 (Critical)

#### Immediate Response
```bash
# 1. Identify command execution points
grep -r "Runtime.getRuntime\|ProcessBuilder\|exec" backend/src/

# 2. Block file upload functionality temporarily
# Add firewall rule:
iptables -A INPUT -p tcp --dport 8080 -m string --string "/upload" --algo bm -j DROP

# 3. Check for unauthorized processes
ps aux | grep -v "java\|postgres\|nginx" | grep -v "^\[.*\]$"
```

#### Permanent Fix
```java
// Replace direct command execution with safe alternatives
// BEFORE (vulnerable):
String command = "convert " + filename + " output.pdf";
Runtime.getRuntime().exec(command);

// AFTER (secure):
ProcessBuilder pb = new ProcessBuilder();
pb.command("convert", validateFilename(filename), "output.pdf");
pb.directory(new File("/safe/working/directory"));

// Add input validation
private String validateFilename(String filename) {
    if (!filename.matches("^[a-zA-Z0-9._-]+$")) {
        throw new IllegalArgumentException("Invalid filename");
    }
    return filename;
}
```

### 3. Authentication Bypass (CWE-287)

**Impact**: Unauthorized access to user accounts
**CVSS**: 9.1 (Critical)

#### Immediate Response
```bash
# 1. Force logout all sessions
redis-cli FLUSHDB  # If using Redis for sessions

# 2. Temporarily require 2FA for all users
# Update application.yml:
security:
  require-2fa: true

# 3. Monitor authentication attempts
tail -f logs/security.log | grep -i "authentication\|login"
```

#### Permanent Fix
```java
// Implement secure authentication
@Service
public class AuthenticationService {
    
    private final PasswordEncoder passwordEncoder;
    private final RateLimitService rateLimitService;
    
    public AuthResult authenticate(String email, String password) {
        // Rate limiting
        if (!rateLimitService.isAllowed(email)) {
            throw new TooManyAttemptsException();
        }
        
        User user = userRepository.findByEmail(email)
            .orElseThrow(() -> new BadCredentialsException("Invalid credentials"));
        
        // Secure password verification
        if (!passwordEncoder.matches(password, user.getPassword())) {
            rateLimitService.recordFailure(email);
            throw new BadCredentialsException("Invalid credentials");
        }
        
        rateLimitService.recordSuccess(email);
        return generateSecureToken(user);
    }
}
```

## High Severity Vulnerabilities

### 4. Cross-Site Scripting (CWE-79)

**Impact**: Account takeover, data theft
**CVSS**: 8.8 (High)

#### Quick Fix
```javascript
// Frontend - Immediate sanitization
import DOMPurify from 'dompurify';

function sanitizeContent(content) {
    return DOMPurify.sanitize(content, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong'],
        ALLOWED_ATTR: []
    });
}

// Use in components
function MessageDisplay({ message }) {
    const safeContent = sanitizeContent(message.content);
    return <div dangerouslySetInnerHTML={{ __html: safeContent }} />;
}
```

#### Backend Security
```java
// Output encoding
@RestController
public class MessageController {
    
    @GetMapping("/messages/{id}")
    public MessageDto getMessage(@PathVariable Long id) {
        Message message = messageService.findById(id);
        
        // HTML encode output
        String safeContent = HtmlUtils.htmlEscape(message.getContent());
        
        return new MessageDto(safeContent);
    }
}
```

### 5. Cross-Site Request Forgery (CWE-352)

**Impact**: Unauthorized actions on user's behalf
**CVSS**: 8.1 (High)

#### Quick Fix
```java
// Enable CSRF protection
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf
            .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            .ignoringRequestMatchers("/api/public/**")
        );
        return http.build();
    }
}
```

#### Frontend Integration
```typescript
// Add CSRF token to requests
const getCsrfToken = () => {
    const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    return token;
};

const apiCall = async (url: string, data: any) => {
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': getCsrfToken(),
        },
        body: JSON.stringify(data),
    });
    return response.json();
};
```

### 6. Path Traversal (CWE-22)

**Impact**: Unauthorized file access
**CVSS**: 7.5 (High)

#### Quick Fix
```java
// Secure file handling
@GetMapping("/files/{filename}")
public ResponseEntity<Resource> getFile(@PathVariable String filename) {
    // Validate filename
    if (!isValidFilename(filename)) {
        return ResponseEntity.badRequest().build();
    }
    
    try {
        Path basePath = Paths.get("/app/files").normalize();
        Path filePath = basePath.resolve(filename).normalize();
        
        // Ensure file is within allowed directory
        if (!filePath.startsWith(basePath)) {
            logger.warn("Path traversal attempt: {}", filename);
            return ResponseEntity.forbidden().build();
        }
        
        Resource resource = new FileSystemResource(filePath);
        return ResponseEntity.ok(resource);
        
    } catch (Exception e) {
        return ResponseEntity.notFound().build();
    }
}

private boolean isValidFilename(String filename) {
    return filename != null &&
           !filename.contains("..") &&
           !filename.contains("/") &&
           !filename.contains("\\") &&
           filename.matches("^[a-zA-Z0-9._-]+$");
}
```

## Medium Severity Vulnerabilities

### 7. Missing Security Headers (CWE-693)

**Impact**: Various client-side attacks
**CVSS**: 6.1 (Medium)

#### Spring Boot Fix
```java
@Configuration
public class SecurityHeadersConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.headers(headers -> headers
            .frameOptions().deny()
            .contentTypeOptions().and()
            .httpStrictTransportSecurity(hstsConfig -> hstsConfig
                .maxAgeInSeconds(31536000)
                .includeSubdomains(true))
            .contentSecurityPolicy("default-src 'self'; script-src 'self'")
        );
        return http.build();
    }
}
```

#### Nginx Fix
```nginx
# Add to nginx.conf
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header Content-Security-Policy "default-src 'self'" always;
```

### 8. Insecure Cookie Configuration (CWE-614)

**Impact**: Session hijacking
**CVSS**: 5.4 (Medium)

#### Quick Fix
```java
// Secure cookie configuration
@Bean
public CookieSerializer cookieSerializer() {
    DefaultCookieSerializer serializer = new DefaultCookieSerializer();
    serializer.setHttpOnly(true);
    serializer.setSecure(true);
    serializer.setSameSite("Strict");
    return serializer;
}

// application.yml
server:
  servlet:
    session:
      cookie:
        secure: true
        http-only: true
        same-site: strict
```

### 9. Information Disclosure (CWE-200)

**Impact**: Sensitive data exposure
**CVSS**: 5.3 (Medium)

#### Quick Fix
```java
// Secure error handling
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGenericException(Exception e) {
        // Log detailed error
        logger.error("Application error", e);
        
        // Return generic error message
        ErrorResponse error = new ErrorResponse(
            "INTERNAL_ERROR",
            "An unexpected error occurred"
        );
        
        return ResponseEntity.status(500).body(error);
    }
}

// Remove sensitive headers
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new HandlerInterceptor() {
            @Override
            public void postHandle(HttpServletRequest request, 
                                 HttpServletResponse response,
                                 Object handler, ModelAndView modelAndView) {
                response.setHeader("Server", "");
                response.setHeader("X-Powered-By", "");
            }
        });
    }
}
```

## Testing Remediation

### Automated Security Tests

```java
@SpringBootTest
class SecurityTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void testSqlInjectionPrevention() {
        String payload = "1' OR '1'='1' --";
        ResponseEntity<String> response = restTemplate.postForEntity(
            "/api/users/search", 
            new SearchRequest(payload), 
            String.class
        );
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);
    }
    
    @Test
    void testXssPrevention() {
        String xssPayload = "<script>alert('xss')</script>";
        ResponseEntity<String> response = restTemplate.getForEntity(
            "/api/content?data=" + xssPayload, 
            String.class
        );
        
        assertThat(response.getBody()).doesNotContain("<script>");
    }
    
    @Test
    void testSecurityHeaders() {
        ResponseEntity<String> response = restTemplate.getForEntity("/", String.class);
        
        assertThat(response.getHeaders().getFirst("X-Frame-Options")).isEqualTo("DENY");
        assertThat(response.getHeaders().getFirst("X-Content-Type-Options")).isEqualTo("nosniff");
    }
}
```

### Manual Testing Scripts

```bash
#!/bin/bash
# security-test.sh

echo "Testing SQL Injection..."
curl -X POST http://localhost:8080/api/users/search \
  -H "Content-Type: application/json" \
  -d '{"query": "admin'\''OR 1=1--"}' \
  -w "Status: %{http_code}\n"

echo "Testing XSS..."
curl "http://localhost:8080/api/content?data=<script>alert('xss')</script>" \
  -w "Status: %{http_code}\n"

echo "Testing Path Traversal..."
curl "http://localhost:8080/api/files/....//....//etc/passwd" \
  -w "Status: %{http_code}\n"

echo "Testing Security Headers..."
curl -I http://localhost:8080/ | grep -E "X-Frame-Options|X-Content-Type-Options"
```

## Incident Response

### Critical Vulnerability Response

1. **Detection** (0-15 minutes)
   - Security alert received
   - Vulnerability confirmed
   - Severity assessed

2. **Containment** (15-60 minutes)
   - Disable affected functionality
   - Block malicious traffic
   - Preserve evidence

3. **Assessment** (1-4 hours)
   - Determine impact scope
   - Identify affected systems
   - Assess data exposure

4. **Remediation** (4-24 hours)
   - Develop fix
   - Test thoroughly
   - Deploy to production

5. **Recovery** (24-48 hours)
   - Restore full functionality
   - Monitor for issues
   - Validate security

6. **Lessons Learned** (48-72 hours)
   - Post-incident review
   - Update procedures
   - Improve defenses

### Communication Plan

#### Internal Communication
- **Security Team**: Immediate notification
- **Development Team**: Within 1 hour
- **Management**: Within 2 hours
- **Legal/Compliance**: Within 4 hours

#### External Communication
- **Customers**: If data breach confirmed
- **Regulators**: As legally required
- **Media**: Only if necessary

### Documentation Template

```markdown
# Security Incident Report

## Summary
- **Incident ID**: SEC-2025-001
- **Date/Time**: 2025-01-15 14:30 UTC
- **Severity**: Critical
- **Status**: Resolved

## Description
Brief description of the vulnerability and its impact.

## Timeline
- 14:30 - Vulnerability discovered
- 14:45 - Incident response initiated
- 15:00 - Affected systems isolated
- 16:30 - Fix developed and tested
- 18:00 - Fix deployed to production
- 20:00 - Full functionality restored

## Impact Assessment
- **Systems Affected**: User authentication
- **Data Exposure**: None confirmed
- **Service Availability**: 2 hours downtime

## Root Cause
Detailed explanation of what caused the vulnerability.

## Remediation Actions
1. Implemented input validation
2. Added security headers
3. Updated authentication logic
4. Enhanced monitoring

## Lessons Learned
1. Need better input validation testing
2. Security reviews for all authentication changes
3. Automated security scanning integration

## Follow-up Actions
- [ ] Update security guidelines
- [ ] Train development team
- [ ] Implement additional monitoring
```

## Prevention Best Practices

### Secure Development Lifecycle

1. **Planning**
   - Threat modeling
   - Security requirements
   - Risk assessment

2. **Design**
   - Security architecture review
   - Defense in depth
   - Principle of least privilege

3. **Implementation**
   - Secure coding guidelines
   - Input validation
   - Output encoding

4. **Testing**
   - Static code analysis
   - Dynamic security testing
   - Penetration testing

5. **Deployment**
   - Security configuration
   - Infrastructure hardening
   - Monitoring setup

6. **Maintenance**
   - Security updates
   - Vulnerability scanning
   - Incident response

### Code Review Security Checklist

- [ ] Input validation implemented
- [ ] SQL queries parameterized
- [ ] Output properly encoded
- [ ] Authentication/authorization checked
- [ ] Security headers configured
- [ ] Error handling secure
- [ ] Crypto algorithms current
- [ ] File operations secure
- [ ] Logging sensitive data avoided
- [ ] Third-party libraries updated

---

## Emergency Contacts

**Security Team**: security@modulo.example.com
**On-Call Engineer**: +1-XXX-XXX-XXXX
**Incident Commander**: +1-XXX-XXX-XXXX
**Legal/Compliance**: legal@modulo.example.com
